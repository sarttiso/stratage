<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>stratage.geochron - stratage 1.1.0.post1.dev1+gc5f3bc7 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style>
  
  <script defer src="https://umami.ts-ht.com/script.js" data-website-id="0775ec1a-107e-4c73-ab7e-08325a4a5fac"></script>
</head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">stratage 1.1.0.post1.dev1+gc5f3bc7 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">stratage 1.1.0.post1.dev1+gc5f3bc7 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../toy-example.html">Toy Example</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/modules.html">Module Reference</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Module Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/stratage.html">stratage package</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for stratage.geochron</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>


<div class="viewcode-block" id="Geochron">
<a class="viewcode-back" href="../../api/stratage.html#stratage.geochron.Geochron">[docs]</a>
<span class="k">class</span> <span class="nc">Geochron</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for handling geochronologic constraints in stratigraphic sections.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    h : array-like</span>
<span class="sd">        List of stratigraphic heights at which temporal constraints are measured. The coordinate increases up section.</span>
<span class="sd">    rv : array-like</span>
<span class="sd">        List of random variables representing the temporal constraints at each height. The members of this list must be objects similar to stats.dist objects with the following methods: pdf, ppf (inverse of cdf).</span>
<span class="sd">    nt : int, optional</span>
<span class="sd">        Number of points for computing numerical pdfs from constraints. Defaults to 500.</span>
<span class="sd">    ndt : int, optional</span>
<span class="sd">        Number of points for computing numerical time increment pdfs. Defaults to 100. This value should be smaller than nt to avoid noisiness in the time increment pdfs.</span>
<span class="sd">    prob_threshold: float, optional</span>
<span class="sd">        Probability threshold for determining the temporal range over which to grid. Defaults to 1e-4.</span>
<span class="sd">    neighbors: str or int, optional</span>
<span class="sd">        Number of neighbors for pairing constraints. Defaults to &#39;all&#39;. Valid options are &#39;all&#39; or integers up to n_constraints-1. All pairs are considered in the &#39;all&#39; method. For integer values n, only n neighboring pairs are considered.</span>
<span class="sd">    n_jobs: int, optional</span>
<span class="sd">        Number of jobs to run in parallel for computing time increment pdfs. Defaults to 1</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    h : list</span>
<span class="sd">        Sorted list of stratigraphic heights.</span>
<span class="sd">    rv : list</span>
<span class="sd">        Sorted list of random variables representing the temporal constraints.</span>
<span class="sd">    n_constraints : int</span>
<span class="sd">        Number of constraints.</span>
<span class="sd">    n_pairs : int</span>
<span class="sd">        Number of pairs of constraints.</span>
<span class="sd">    nt : int</span>
<span class="sd">        Number of points for computing numerical pdfs from constraints.</span>
<span class="sd">    ndt : int</span>
<span class="sd">        Number of points for computing numerical time increment pdfs.</span>
<span class="sd">    lower_idx : list</span>
<span class="sd">        List of indices into h and rv for the lower constraint in each pair.</span>
<span class="sd">    upper_idx list</span>
<span class="sd">        List of indices into h and rv for the upper constraint in each pair.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">rv</span><span class="p">,</span> <span class="n">nt</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">ndt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">prob_threshold</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Geochron object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># read in heights h, and random variables rv corresponding to the geochronologic constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rv</span> <span class="o">=</span> <span class="n">rv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nt</span> <span class="o">=</span> <span class="n">nt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndt</span> <span class="o">=</span> <span class="n">ndt</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="c1"># sort the heights and random variable representations</span>
        <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sort_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rv</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rv</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sort_idx</span><span class="p">]</span>

        <span class="c1"># establish unique pairs of constraints, distinguising in a consistent way the relative stratigraphic height of each</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pair_constraints</span><span class="p">(</span><span class="n">neighbors</span><span class="o">=</span><span class="n">neighbors</span><span class="p">)</span>

        <span class="c1"># TODO verify that this grid resolves the probability distributions that were given</span>

        <span class="c1"># save probability threshold for filtering of time grid based on each constraint&#39;s pdf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob_threshold</span> <span class="o">=</span> <span class="n">prob_threshold</span>

        <span class="c1"># create time increment pdfs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_increment_pdfs</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pair_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pair the geochronologic constraints that will be used to compute the time increment pdfs.</span>

<span class="sd">        Determines unique pairs of constraints, ordered such that the first response is lower stratigraphically and the second is higher. outputs indices for these pairs as upper_idx and lower_idx (which index in to h, rv)</span>
<span class="sd">        Again, ensure that heights are increasing up section (i.e. with time)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        neighbors : str or int, optional</span>
<span class="sd">            Number of neighbors for pairing constraints. Defaults to &#39;all&#39;. Valid options are &#39;all&#39; or integers up to n_constraints-1. All pairs are considered in the &#39;all&#39; method. For integer values n, only n neighboring pairs are considered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">upper_idx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lower_idx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">neighbors</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">neighbors</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;Invalid string for pairing constraints; must be &quot;all&quot; or an integer.&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">neighbors</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s1">&#39;Invalid value for pairing constraints; must be &quot;all&quot; or an integer.&#39;</span>
            <span class="k">assert</span> <span class="n">neighbors</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Neighbors must be less than n_constraints = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span><span class="si">}</span><span class="s1">.&#39;</span>
        <span class="k">if</span> <span class="n">neighbors</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="c1"># loop over all pairs of constraints</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)):</span>
                    <span class="c1"># if constraints share height, skip</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">jj</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="n">upper_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span>
                    <span class="n">lower_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="c1"># go forwards in neighbors</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">ii</span><span class="o">+</span><span class="n">neighbors</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">])):</span>
                    <span class="c1"># if neighboring constraints share height, skip</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">jj</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="n">upper_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span>
                    <span class="n">lower_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>

        <span class="c1"># always include pairing of  lowermost and uppermost constraints</span>
        <span class="c1"># check if lowermost and uppermost constraints are already paired</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lower_idx</span><span class="p">))</span> <span class="k">if</span> <span class="n">lower_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                   <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">upper_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lower_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">upper_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lower_idx</span> <span class="o">=</span> <span class="n">lower_idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upper_idx</span> <span class="o">=</span> <span class="n">upper_idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pairs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_idx</span><span class="p">)</span>

<div class="viewcode-block" id="Geochron.model_weights">
<a class="viewcode-back" href="../../api/stratage.html#stratage.geochron.Geochron.model_weights">[docs]</a>
    <span class="k">def</span> <span class="nf">model_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the weights for units and contacts based on their bounding by</span>
<span class="sd">        geochron constraints.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        units : numpy.ndarray</span>
<span class="sd">            Bottom and top heights of units in section. 2d array (nx2) of bottom and top heights for each of n units</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        alpha : numpy.ndarray</span>
<span class="sd">            2D array (NxL) of weights for each of N units and L pairs of geochron constraints.</span>
<span class="sd">        beta : numpy.ndarray</span>
<span class="sd">            2D array (MxL) of weights for each of M contacts and L pairs of geochron constraints.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError</span>
<span class="sd">            If any rows in alpha or beta are entirely zero, indicating unconstrained model parameters.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Run after :py:func:`stratagemc.trim_units()`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unit_thicks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">contacts</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">n_units</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_contacts</span> <span class="o">=</span> <span class="n">n_units</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1"># initialize</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pairs</span><span class="p">))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_contacts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pairs</span><span class="p">))</span>

        <span class="c1"># loop over pairs of constraints (see notes  from 12/16/2020 for motivation of this code)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pairs</span><span class="p">):</span>
            <span class="n">pair_top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
            <span class="n">pair_bottom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
            <span class="c1"># units</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_units</span><span class="p">):</span>
                <span class="n">unit_top</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">unit_bottom</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="c1"># these factors are defined in notes; need to scan</span>
                <span class="n">top_fact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([(</span><span class="n">unit_top</span><span class="o">-</span><span class="n">pair_top</span><span class="p">)</span><span class="o">/</span><span class="n">unit_thicks</span><span class="p">[</span><span class="n">jj</span><span class="p">],</span> <span class="mi">0</span><span class="p">]),</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">bot_fact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([(</span><span class="n">pair_bottom</span><span class="o">-</span><span class="n">unit_bottom</span><span class="p">)</span><span class="o">/</span><span class="n">unit_thicks</span><span class="p">[</span><span class="n">jj</span><span class="p">],</span> <span class="mi">0</span><span class="p">]),</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">frac</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">top_fact</span> <span class="o">-</span> <span class="n">bot_fact</span>
                <span class="n">alpha</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">frac</span>

        <span class="c1"># finally scale alpha by the thickness of the unit</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">unit_thicks</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pairs</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># contacts</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_contacts</span><span class="p">):</span>
            <span class="c1"># partial bounding of contacts is not a concern, so we can just deal with one set of straddling indices</span>
            <span class="n">tot_bnd_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">straddling</span><span class="p">(</span><span class="n">contacts</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">beta</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">tot_bnd_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># if any rows in either of matrices above are entirely zero, it means that there are model parameters that are completely unconstrained, which cannot be the case (at this point)</span>
        <span class="k">assert</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">alpha</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> \
            <span class="s1">&#39;some units are not bounded at all by geochronologic constraints&#39;</span>
        <span class="k">assert</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">beta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> \
            <span class="s1">&#39;some contacts are not bounded at all by geochronologic constraints&#39;</span>

        <span class="k">return</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span></div>


    <span class="k">def</span> <span class="nf">_time_increment_pdfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given the provided geochronologic constraints, numerically evaluate the time increment pdfs for all pairs of constraints. These increments respect stratigrahic superosition of rv2 over rv1, meaning that it is always positive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get temporal bounds for each constraint that constrain given thresholds of probability (so we ignore times of zero probability)</span>
        <span class="n">rv_t</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># list of time grids for each constraint</span>
        <span class="n">rv_pdf</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of pdfs for each constraint</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">):</span>
            <span class="n">cur_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rv</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prob_threshold</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">prob_threshold</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nt</span><span class="p">))</span>
            <span class="n">cur_pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rv</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">cur_t</span><span class="p">)</span>
            <span class="n">rv_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_t</span><span class="p">)</span>
            <span class="n">rv_pdf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_pdf</span><span class="p">)</span>

        <span class="c1"># compute pairwise increment pdfs</span>
        <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pdts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pairs</span><span class="p">),</span>
                        <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Constructing time increment pdfs&#39;</span><span class="p">):</span>
                <span class="n">pdt</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pairwise_increment_pdf</span><span class="p">(</span><span class="n">rv_t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span>
                                                    <span class="n">rv_pdf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span>
                                                    <span class="n">rv_t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span>
                                                    <span class="n">rv_pdf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
                <span class="n">pdts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdt</span><span class="p">)</span>
                <span class="n">dts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pairwise_increment_pdf</span><span class="p">)(</span><span class="n">rv_t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span>
                                                                                <span class="n">rv_pdf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span>
                                                                                <span class="n">rv_t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span>
                                                                                <span class="n">rv_pdf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
                                          <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pairs</span><span class="p">),</span>
                                                         <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Constructing time increment pdfs&#39;</span><span class="p">))</span>
            <span class="n">pdts</span><span class="p">,</span> <span class="n">dts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pdts</span> <span class="o">=</span> <span class="n">pdts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dts</span> <span class="o">=</span> <span class="n">dts</span>
        <span class="c1"># assign maximum likelihood for each pair of constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dts_max</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dts</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdts</span><span class="p">[</span><span class="n">ii</span><span class="p">])]</span>
                        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pairs</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_pairwise_increment_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For a pair of constraints, numerically evaluate the time increment pdf.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t1 : arraylike</span>
<span class="sd">            Time grid for the lower constraint</span>
<span class="sd">        p1 : arraylike</span>
<span class="sd">            Probability density function for the lower constraint</span>
<span class="sd">        t2 : arraylike</span>
<span class="sd">            Time grid for the upper constraint</span>
<span class="sd">        p2 : arraylike</span>
<span class="sd">            Probability density function for the upper constraint</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pdf : numpy.ndarray </span>
<span class="sd">            Time increment pdf for the pair of constraints (Gamma in manuscript)</span>
<span class="sd">        dt : numpy.ndarray</span>
<span class="sd">            Time increments over which pdf is evaluated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># bounds on lower</span>
        <span class="n">l1</span><span class="p">,</span> <span class="n">u1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">t1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
        <span class="c1"># bounds on upper</span>
        <span class="n">l2</span><span class="p">,</span> <span class="n">u2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">t2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>

        <span class="c1"># vector of time increments for the pair of constraints</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">l2</span><span class="o">-</span><span class="n">u1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">u2</span><span class="o">-</span><span class="n">l1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndt</span><span class="p">)</span>

        <span class="c1"># make time grid for current pair of constraints</span>
        <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="c1"># make pdf grid for current pair of constraints</span>
        <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>

        <span class="c1"># for the ith pair, compute joint pdf (assuming independence)</span>
        <span class="n">PJ</span> <span class="o">=</span> <span class="n">P1</span> <span class="o">*</span> <span class="n">P2</span>

        <span class="c1"># now just integrate over all dt&#39;s</span>
        <span class="n">cdt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span>
        <span class="n">idx_spos</span> <span class="o">=</span> <span class="p">(</span><span class="n">T2</span> <span class="o">&gt;</span> <span class="n">T1</span><span class="p">)</span>  <span class="c1"># impose stratigraphic superposition</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">cur_dt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
            <span class="c1"># impose stratigraphic superposition while computing time increment pdf (first term)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">idx_spos</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">T2</span> <span class="o">&lt;</span> <span class="n">T1</span><span class="o">+</span><span class="n">cur_dt</span><span class="p">)</span>
            <span class="n">cdt</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PJ</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

        <span class="c1"># normalize correctly (CDF should sum to one, the max)</span>
        <span class="n">cdt</span> <span class="o">=</span> <span class="n">cdt</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cdt</span><span class="p">)</span>
        <span class="c1"># make into pdf</span>
        <span class="n">pdt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">cdt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pdt</span><span class="p">,</span> <span class="n">dt</span>

<div class="viewcode-block" id="Geochron.straddling">
<a class="viewcode-back" href="../../api/stratage.html#stratage.geochron.Geochron.straddling">[docs]</a>
    <span class="k">def</span> <span class="nf">straddling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the indices of pairs of constraints that straddle a given height.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        height : float</span>
<span class="sd">            The height in section.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        idx : numpy.ndarray</span>
<span class="sd">            The indices (into self.lower_idx, self.upper_idx) that straddle the given height.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pairs</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]]:</span>
                <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">idx</span></div>


<div class="viewcode-block" id="Geochron.plot_constraints">
<a class="viewcode-back" href="../../api/stratage.html#stratage.geochron.Geochron.plot_constraints">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plotstyle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the geochronologic constraints.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax : matplotlib.axes.Axes</span>
<span class="sd">            The axes on which to plot the constraints. If None, a new figure is created.</span>
<span class="sd">        tol : int</span>
<span class="sd">            The number of orders of magnitude below the maximum pdf value to plot.</span>
<span class="sd">        scale : float</span>
<span class="sd">            The scale factor for the pdfs.</span>
<span class="sd">        plotstyle : dict, optional</span>
<span class="sd">            Additional keyword arguments passed to the matplotlib plot function for visualizing constraint pdfs, defaults to None. If None, the default plot style is used.</span>
<span class="sd">        fillstyle : dict, optional</span>
<span class="sd">            Additional keyword arguments passed to the matplotlib fill_between function for visualizing constraint pdfs, defaults to None. If None, the default fill style is used.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax : matplotlib.axes.Axes</span>
<span class="sd">            The axes on which the constraints are plotted.</span>
<span class="sd">        h : list</span>
<span class="sd">            The handles for the plotted constraints. Each element of the list is a list of handles for the fill and line plots for a single constraint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Height&#39;</span><span class="p">)</span>

        <span class="c1"># set up default styles</span>
        <span class="n">plotstyle_def</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">fillstyle_def</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;facecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;lightgrey&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="c1"># merge default and user-defined styles</span>
        <span class="k">if</span> <span class="n">plotstyle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plotstyle</span> <span class="o">=</span> <span class="n">plotstyle_def</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plotstyle</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">plotstyle_def</span><span class="p">,</span> <span class="o">**</span><span class="n">plotstyle</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">fillstyle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fillstyle</span> <span class="o">=</span> <span class="n">fillstyle_def</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fillstyle</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fillstyle_def</span><span class="p">,</span> <span class="o">**</span><span class="n">fillstyle</span><span class="p">}</span>

        <span class="n">h</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">):</span>
            <span class="n">cur_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rv</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prob_threshold</span><span class="p">),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">rv</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">prob_threshold</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nt</span><span class="p">)</span>
            <span class="n">cur_pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rv</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">cur_t</span><span class="p">)</span>
            <span class="c1"># only plot the part of the pdf that matters</span>
            <span class="n">idx_pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cur_pdf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cur_pdf</span><span class="p">))</span> <span class="o">-</span> <span class="n">tol</span><span class="p">)</span>

            <span class="c1"># scale it to be visible</span>
            <span class="n">pdf_scale</span> <span class="o">=</span> <span class="n">scale</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cur_pdf</span><span class="p">[</span><span class="n">idx_pdf</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cur_pdf</span><span class="p">[</span><span class="n">idx_pdf</span><span class="p">]))</span>
            <span class="n">cur_pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="n">pdf_scale</span> <span class="o">*</span> <span class="n">cur_pdf</span>

            <span class="n">cur_h_fill</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">cur_t</span><span class="p">[</span><span class="n">idx_pdf</span><span class="p">],</span>
                                         <span class="n">cur_pdf</span><span class="p">[</span><span class="n">idx_pdf</span><span class="p">],</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                         <span class="o">**</span><span class="n">fillstyle</span><span class="p">)</span>
            <span class="n">cur_h_line</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cur_t</span><span class="p">[</span><span class="n">idx_pdf</span><span class="p">],</span> <span class="n">cur_pdf</span><span class="p">[</span><span class="n">idx_pdf</span><span class="p">],</span> <span class="o">**</span><span class="n">plotstyle</span><span class="p">)</span>
            <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cur_h_fill</span><span class="p">,</span> <span class="n">cur_h_line</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">ax</span><span class="p">,</span> <span class="n">h</span></div>


<div class="viewcode-block" id="Geochron.plot_increment_pdfs">
<a class="viewcode-back" href="../../api/stratage.html#stratage.geochron.Geochron.plot_increment_pdfs">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_increment_pdfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the time increment pdfs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax : matplotlib.axes.Axes, optional</span>
<span class="sd">            The axes on which to plot the increment pdfs. Defaults to None. If None, a new figure is created.</span>
<span class="sd">        tol : int, optional</span>
<span class="sd">            The number of orders of magnitude below the maximum pdf value to plot. Defaults to 3.</span>
<span class="sd">        scale : float, optional</span>
<span class="sd">            The scale factor for the pdfs. Defaults to 1.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax : matplotlib.axes.Axes</span>
<span class="sd">            The axes on which the increment pdfs are plotted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Increment&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pair Index&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pairs</span><span class="p">):</span>
            <span class="n">cur_pair_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;lower: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span><span class="si">}</span><span class="s1">, upper: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">cur_pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdts</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">min_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dts</span><span class="p">])</span>
            <span class="n">max_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dts</span><span class="p">])</span>
            <span class="n">pdf_scale</span> <span class="o">=</span> <span class="n">scale</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cur_pdf</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cur_pdf</span><span class="p">))</span>
            <span class="n">cur_pdf</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="n">pdf_scale</span> <span class="o">*</span> <span class="n">cur_pdf</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                            <span class="n">cur_pdf</span><span class="p">,</span>
                            <span class="n">ii</span><span class="p">,</span>
                            <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">min_dt</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">cur_pair_label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pairs</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">min_dt</span><span class="p">,</span> <span class="n">max_dt</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ax</span></div>
</div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Adrian Tasistro-Hart
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=e0dbd34f"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>